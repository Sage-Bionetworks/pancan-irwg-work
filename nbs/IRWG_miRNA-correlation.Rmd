---
title: "PanCan IRWG miRNA Correlative Analysis"
author: "James A. Eddy"
date: '`r lubridate::today()`'
output:
  html_notebook:
    code_folding: hide
    fig_width: 8
    toc: yes
    toc_float: yes
---

# Summary

Exploring associations of miRNA expression levels across tumor types in TCGA with suggested correlates defined by the Immune Response Working Group:

+ Overall Leukocyte fraction  
+ Individual Relative CIBERSORT fraction  
+ Mutation Load  
+ TCR,BCR Diversity  
+ Expression of  
    + IFNG,IFN-gamma  
    + PRF1,Perforin  
    + GZMA,Granzyme A  
    + PDCD1,PD-1  
    + CD274,PD-L1  
    + PDCD1LG2,PD-L2  
    + IL10,IL-10  
    + TGFB1,TGF-beta  
    + IDO1,IDO  
    + HLA-A  


```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE, cache=FALSE}
# Synapse client
library(synapseClient)

# viz packages
library(ggthemes)
library(viridis)
library(ggbeeswarm)

# packages for general data munging, formatting
library(feather)
library(stringr)
library(forcats)
library(broom)
library(tidyverse)

my_theme_bw <- function() {
    theme_bw() +
        theme(axis.title = element_text(face = "bold", size = rel(0.9)),
              legend.title = element_text(face = "bold"),
              plot.title = element_text(face = "bold"))
}
ggplot2::theme_set(my_theme_bw())
scale_fill_discrete <- function(...) scale_fill_colorblind(...)
scale_fill_continuous <- function(...) scale_fill_viridis(...)
scale_colour_discrete <- function(...) scale_color_colorblind(...)
scale_colour_continuous <- function(...) scale_color_viridis(...)
```

-----

\  

# Prepare data

## Retrieve miRNA data from Synapse

Data are stored on Synapse in the folder `syn6171109`.

```{r, message=FALSE, warning=FALSE}
if (!dir.exists("data")) {
    dir.create("data")
}
synapseLogin()
mirna_synfolder <- "syn6171109"
mirna_synfiles <- synapseQuery(
    sprintf('select * from file where parentId=="%s"', mirna_synfolder)
)

# download files and store data/paths in new data frame
mirna_files <- mirna_synfiles %>% 
    mutate(file_data = map(file.id, function(synid) {
        synGet(synid, downloadLocation = "data/")
    }),
    file_path = map_chr(file_data, getFileLocation))
```

## Load miRNA data

Sample characteristics are stored in a tab-delimited text file (Synapse ID: `syn7222010`) and can be loaded with `read_tsv()`.

```{r}
# load sample data
mirna_sample_file <- mirna_files %>% 
    filter(file.id == "syn7222010") %>% 
    .[["file_path"]]
mirna_sample_df <- read_tsv(mirna_sample_file)
```

miRNA normalized, batch corrected expression values for all samples are stored as a matrix in a CSV file (Synapse ID: `syn7201053`) and can be loaded with `read_csv()`.

```{r}
# load normalized, batch-corrected expression data
mirna_norm_file <- mirna_files %>% 
    filter(file.id == "syn7201053") %>% 
    .[["file_path"]]
mirna_norm_df <- read_csv(mirna_norm_file, progress = FALSE)
```

```{r}
mirna_norm_df %>% 
    group_by(Correction) %>% 
    tally()
```

-----

\  

# Explore miRNA data

## Sample characteristics

The table `mirna_sample_df` contains `r ncol(mirna_sample_df)` columns describing the `r nrow(mirna_sample_df)` samples in the data. The `Sample_Type` column corresponds to TCGA **sample type codes**, which are defined [here](https://gdc.cancer.gov/resources-tcga-users/tcga-code-tables/sample-type-codes). The following sample types are included in the miRNA data:

```{r}
mirna_sample_df %>% 
    group_by(Sample_Type) %>% 
    tally()
```

Based on the codes, this is the distribution of sample types:

```{r}
mirna_sample_df %>% 
    group_by(Sample_Type) %>% 
    tally() %>% 
    mutate(Definition = case_when(
        .$Sample_Type == 1 ~ "Primary Solid Tumor",
        .$Sample_Type == 2 ~ "Recurrent Solid Tumorr",
        .$Sample_Type == 3 ~ "Primary Blood Derived Cancer - Peripheral Blood",
        .$Sample_Type == 5 ~ "Additional - New Primary",
        .$Sample_Type == 6 ~ "Metastatic",
        .$Sample_Type == 7 ~ "Additional Metastatic",
        .$Sample_Type == 11 ~ "Solid Tissue Normal"
    ))
```

Additionally, the following disease types are included:

```{r}
mirna_sample_df %>% 
    group_by(Disease) %>% 
    tally()
```

And technical variables:

```{r}
mirna_sample_df %>% 
    group_by(Protocol, Platform) %>% 
    tally()
```


## miRNA expression values

Below is an (admittedly ugly) spot check of the distribution of gene expression values in the miRNA data. I picked 8 genes at random (as this corresponds to the number of colors in a standard discrete palette).

```{r}
set.seed(0)
# randomly select 8 genes to plot
norm_sub_df <- mirna_norm_df %>% 
    sample_n(8) %>% 
    gather("sample", "expression", -Genes, -Correction)
```


```{r}
norm_sub_df %>% 
    left_join(mirna_sample_df, by = c("sample" = "id")) %>% 
    ggplot(aes(x = Disease, y = log2(expression + 1))) +
    geom_violin(aes(fill = Genes), alpha = 0.2, 
                position = "identity", scale = "width") +
    coord_flip()
```


```{r}
# convert expression df to matrix
mirna_norm_mat <- mirna_norm_df %>% 
    select(one_of(c("Genes", mirna_sample_df$id))) %>% 
    column_to_rownames("Genes") %>% 
    as.matrix()
```





